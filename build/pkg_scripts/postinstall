#!/bin/bash

echo "RTL88xxAU Driver Post-installation Script"

KEXT_PATH="/System/Library/Extensions/RTL88xxAU.kext"

# Set correct permissions
echo "Setting permissions..."
chown -R root:wheel "$KEXT_PATH"
chmod -R 755 "$KEXT_PATH"
chmod 644 "$KEXT_PATH/Contents/Info.plist"

# Update kernel extension cache
echo "Updating kernel extension cache..."
if ! kextcache -system-caches; then
    echo "WARNING: Failed to update kernel extension cache"
    echo "You may need to restart your Mac for the driver to load properly"
fi

# Try to load the driver
echo "Attempting to load RTL88xxAU driver..."
if kextload "$KEXT_PATH" 2>/dev/null; then
    echo "Driver loaded successfully!"
else
    echo "Note: Driver not loaded automatically."
    echo "This is normal if no compatible device is connected."
    echo "The driver will load automatically when a compatible device is plugged in."
fi

# Display completion message
echo ""
echo "======================================"
echo "RTL88xxAU Driver Installation Complete"
echo "======================================"
echo ""
echo "Supported devices:"
echo "- Realtek RTL8812AU USB WiFi adapters"
echo "- Realtek RTL8821AU USB WiFi adapters"
echo "- Realtek RTL8814AU USB WiFi adapters"
echo "- Alfa AWUS1900 (RTL8814AU)"
echo "- Alfa AWUS036ACS (RTL8812AU)"
echo ""
echo "To verify installation:"
echo "  kextstat | grep RTL88xxAU"
echo ""
echo "To check device detection:"
echo "  system_profiler SPUSBDataType | grep -i realtek"
echo ""
echo "If you experience issues:"
echo "1. Restart your Mac"
echo "2. Check System Integrity Protection: csrutil status"
echo "3. View logs: log show --predicate 'senderImagePath contains \"RTL88xxAU\"'"
echo ""

exit 0
